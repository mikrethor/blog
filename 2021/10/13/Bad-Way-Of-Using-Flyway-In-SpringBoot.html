<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Which of Flyway or JPA should be responsible of generating your db structure? - Xavier Bouclet
    
  </title>

  <meta name="description" content="Which of Flyway or JPA should be responsible of generating your db structure? 1. What is Flyway ?">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úçüèª</text></svg>">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/vendor/highlight/css/syntax_github.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://startbootstrap.github.io/2021/10/13/Bad-Way-Of-Using-Flyway-In-SpringBoot.html">
  <link rel="alternate" type="application/rss+xml" title="Xavier Bouclet" href="/feed.xml">

  <script defer data-domain="xavierbouclet.com" src="https://plausible.io/js/script.js"></script>
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Xavier Bouclet</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/conferences">Talks</a>
        </li>
<!--        Deactivated because of cors-->
<!--        <li class="nav-item">-->
<!--          <a class="nav-link" href="/contact">Contact</a>-->
<!--        </li>-->
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/posts/Flyway-plus-SpringBoot.png')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Which of Flyway or JPA should be responsible of generating your db structure?</h1>
            
            <h2 class="subheading">Which of Flyway or JPA should be responsible of generating your db structure?</h2>
            
            <span class="meta">Posted by
              <a href="#">Xavier Bouclet</a>
              on October 13, 2021 &middot; <span class="reading-time" title="Estimated read time">
  
   5 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-10 mx-auto">

        <h1>Which of Flyway or JPA should be responsible of generating your db structure?</h1>
<div class="sect1">
<h2 id="1_what_is_flyway">1. What is Flyway ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://flywaydb.org/documentation/">Flyway</a> is an open-source database migration tool.
It helps to keep track of all the changes done on the DB.
It&#8217;s done with the help of the table "flyway_schema_history".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2021-10-13-flyway_schema_history.png" alt="Flyway Schema History">
</div>
</div>
<div class="paragraph">
<p>In a Java project, Flyway applies SQL file or Java Migration code to the database (through command-line, Maven plugin,&#8230;&#8203;).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="2_how_flyway_is_intended_to_be_used_with_spring_boot">2. How Flyway is intended to be used with Spring Boot ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Spring Boot everything being configured by default, the Spring Boot developers have chosen to execute Flyway and then trigger the Entity Manager.
But some people have decided to delegate that to JPA and most of them visited at some point that <a href="https://stackoverflow.com/questions/37097876/spring-boot-hibernate-and-flyway-boot-order">StackOverflow page</a>.</p>
</div>
<div class="paragraph">
<p>Most of this post comes from the content on that page and the few hours I needed to make it work on our project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3_what_happens_if_people_wants_to_let_jpa_create_the_tables_structure_instead_of_flyway">3. What happens if people wants to let JPA create the tables structure instead of Flyway ?</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="prior_2_5_x">Prior 2.5.X</h3>
<div class="paragraph">
<p>As someone on the stackoverflow page wrote, we could prior to 2.3 trigger Flyway after JPA by adding this property to our application.properties file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">spring.flyway.enabled</span><span class="p">=</span><span class="s">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That property prevent Flyway to be autoconfigured by Spring Boot.</p>
</div>
<div class="paragraph">
<p>And to use Flyway anyway and trigger it after JPA you need to add this following @Configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MigrationConfiguration</span> <span class="o">{</span>

    <span class="cm">/**
     * Override default flyway initializer to do nothing
     */</span>
    <span class="nd">@Bean</span>
    <span class="nc">FlywayMigrationInitializer</span> <span class="nf">flywayInitializer</span><span class="o">(</span><span class="nc">Flyway</span> <span class="n">flyway</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FlywayMigrationInitializer</span><span class="o">(</span><span class="n">flyway</span><span class="o">,</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">-&gt;{}</span> <span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Create a second flyway initializer to run after jpa has created the schema
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@DependsOn</span><span class="o">(</span><span class="s">"entityManagerFactory"</span><span class="o">)</span>
    <span class="nc">FlywayMigrationInitializer</span> <span class="nf">delayedFlywayInitializer</span><span class="o">(</span><span class="nc">Flyway</span> <span class="n">flyway</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FlywayMigrationInitializer</span><span class="o">(</span><span class="n">flyway</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The @DependsOn annotation is what trigger the Flyway migration after the "EntityManagerFactory" has been created by Spring Boot.</p>
</div>
<div class="paragraph">
<p>Unfortunately for us that way doesn&#8217;t work anymore with Spring boot 2.5.X</p>
</div>
</div>
<div class="sect2">
<h3 id="after_2_5_x">After 2.5.X</h3>
<div class="paragraph">
<p>We need to remove the Flyway autoconfigure with another way than the one we used prior.
It&#8217;s done with a "BeanFactoryPostProcessor".
We need to exclude the DependsOn from 2 classes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataSourceScriptDatabaseInitializer</p>
</li>
<li>
<p>EntityManagerFactory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s call our bean "FlywayDeferrerPostProcessor".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FlywayDeferrerPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanFactoryPostProcessor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="n">excludeDependsOnFlywayFromBean</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="nc">DataSourceScriptDatabaseInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">excludeDependsOnFlywayFromBean</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="nc">EntityManagerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">excludeDependsOnFlywayFromBean</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">beanClass</span><span class="o">))</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">beanFactory:</span><span class="o">:</span><span class="n">getBeanDefinition</span><span class="o">)</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">().</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">it</span> <span class="o">-&gt;</span> <span class="n">it</span><span class="o">.</span><span class="na">setDependsOn</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">()).</span><span class="na">filter</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"flyway"</span><span class="o">)).</span><span class="na">toArray</span><span class="o">(</span><span class="nc">String</span><span class="o">[]::</span><span class="k">new</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="4_conclusion">4. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When we migrated from Spring Boot 2.3.X to 2.5.X, It took me a few hours to make Flyway work properly after JPA.
It worked with 2.3 but Spring Boot changed something and it broke.
And that&#8217;s normal because that&#8217;s not the way Spring Boot is supposed to work.
So we shouldn&#8217;t fight against the Spring Boot way of using Flyway.
Now that our migration works we are gonna move away from JPA building the db structure and go back to use plain old Flyway.
And you should to.</p>
</div>
</div>
</div>

        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/2021/03/14/Native-java-api-SpringBoot.html" data-toggle="tooltip" data-placement="top" title="Building a Java native REST API ‚Äî Part 1: Spring Boot">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2021/12/19/The-weight-of-annotations-mockito.html" data-toggle="tooltip" data-placement="top" title="The weight of annotations @Mock and @MockBean">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>

  <footer class="entry-meta">
    
    
<section class="post-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'https-mikrethor-github-io-blog'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


    
  </footer>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:mikrethor@gmail.com.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/XavierBOUCLET">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/üá®üá¶-xavier-bouclet-667b0431/">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/mikrethor">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; Xavier Bouclet 2025</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XVG0Q9ZG4E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XVG0Q9ZG4E');
</script>


  

</body>

</html>
