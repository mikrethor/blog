<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Be specific with your Spring data repositories - Xavier Bouclet
    
  </title>

  <meta name="description" content="Be specific with your Spring data repositories 1. Purpose of this blog post">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úçüèª</text></svg>">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/vendor/highlight/css/syntax_github.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://startbootstrap.github.io/2022/06/30/H2-TestContainers-PostgreSQL.html">
  <link rel="alternate" type="application/rss+xml" title="Xavier Bouclet" href="/feed.xml">

  <script defer data-domain="xavierbouclet.com" src="https://plausible.io/js/script.js"></script>
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Xavier Bouclet</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/conferences">Talks</a>
        </li>
<!--        Deactivated because of cors-->
<!--        <li class="nav-item">-->
<!--          <a class="nav-link" href="/contact">Contact</a>-->
<!--        </li>-->
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/posts/2022-06-30-bg-testcontainers.png')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Be specific with your Spring data repositories</h1>
            
            <h2 class="subheading">Be specific with your Spring data repositories</h2>
            
            <span class="meta">Posted by
              <a href="#">Xavier Bouclet</a>
              on June 30, 2022 &middot; <span class="reading-time" title="Estimated read time">
  
   4 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-10 mx-auto">

        <h1>Be specific with your Spring data repositories</h1>
<div class="sect1">
<h2 id="1_purpose_of_this_blog_post">1. Purpose of this blog post</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this post is to detail why our build &amp; test time went from 3 min 30 to 1 hour just by switching from H2 to PostgreSQL with Testcontainers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="2_ascertainment_1_hour_build_time">2. Ascertainment - 1 hour build time</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to explain why our build time went through the rough, let&#8217;s give some context.</p>
</div>
<div class="paragraph">
<p>Firstly, our stack is :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Boot 2.7</p>
</li>
<li>
<p>Java 17</p>
</li>
<li>
<p>PostgreSQL</p>
</li>
<li>
<p>Junit/Cucumber</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, our database schema, we store mostly media contents and our schema could be summed up with a table Content storing the common field of all contents and then a specific table by content type. It translates into at least 15 tables with a reference on the Content table.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2022-06-30-db-diagram.png" alt="Database" width="100%">
</div>
</div>
<div class="paragraph">
<p>The two main reasons our build time exploded are :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@ManyToMany relation</p>
</li>
<li>
<p>The use of ContentRepository instead of specific repository.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3_solution">3. Solution</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="3_1_manytomany_relation">3.1. @ManyToMany relation</h3>
<div class="paragraph">
<p>ManyToMany relation should be avoided and when mandatory, they should be done <a href="https://vladmihalcea.com/the-best-way-to-use-the-manytomany-annotation-with-jpa-and-hibernate/">properly</a>.
Of course, we haven&#8217;t used the proper way and we weren&#8217;t not able to do so because our code was using List instead of Set and it would have been too much work to replace that.</p>
</div>
<div class="paragraph">
<p>But we found some interesting things by pushing our analysis, the @ManyToMany relation between Story and Content was instead a relation between Story and PhotoGallery so by changing Content to PhotoGallery we divided our build time by two (most of our test are using Story)</p>
</div>
<div class="paragraph">
<p>Before :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2022-06-30-many-to-many-story-content.png" alt="ManyToMany Story Content" width="100%">
</div>
</div>
<div class="paragraph">
<p>After :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2022-06-30-many-to-many-story-photogallery.png" alt="ManyToMany Story PhotoGallery">
</div>
</div>
</div>
<div class="sect2">
<h3 id="3_2_the_use_of_contentrepository">3.2. The use of ContentRepository</h3>
<div class="paragraph">
<p>Most of the time, our code uses a ContentRepository, but we already know which content type we want.
By using a specific repository when possible we managed to divide our build time again.</p>
</div>
<div class="paragraph">
<p>Bellow, an example of what we did :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2022-06-30-specific-repository.png" alt="Specific repository">
</div>
</div>
<div class="paragraph">
<p>Before both methods used ContentRepository and that prevented PostgreSQL to do its optimization.</p>
</div>
</div>
<div class="sect2">
<h3 id="3_3_test_optimisation">3.3. Test optimisation</h3>
<div class="paragraph">
<p>Before our optimisations, our tests used the same repositories as our code to clean up our tables.
We changed those with jdbcTemplate to use SQL queries to clean up our tables.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../img/posts/2022-06-30-jdbcTemplate.png" alt="JdbcTemplate">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="4_conclusion">4. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before, our code was optimized for H2 and now our code is optimized for PostgreSQL.
And thanks to our build time problem, we managed to find optimizations that are now in production. On our production database, the change from Content to PhotoGallery went from an average of 95ms to 5ms maximum.</p>
</div>
<div class="paragraph">
<p>To improve database performance, try to be as specific as possible to help your SGBD to do its work.</p>
</div>
<div class="paragraph">
<p>To conclude, it&#8217;s always important to reduce the feedback loop.
Now our test database is also a PostgresSQL database and we will detect when a query is not optimized as soon as possible.</p>
</div>
</div>
</div>

        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/2021/12/19/The-weight-of-annotations-mockito.html" data-toggle="tooltip" data-placement="top" title="The weight of annotations @Mock and @MockBean">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2022/07/07/Simple-Kafka-Producer-Consumer.html" data-toggle="tooltip" data-placement="top" title="Let&#8217;s write a simple Kafka producer/consumer">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>

  <footer class="entry-meta">
    
    
<section class="post-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'https-mikrethor-github-io-blog'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


    
  </footer>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:mikrethor@gmail.com.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/XavierBOUCLET">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/üá®üá¶-xavier-bouclet-667b0431/">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/mikrethor">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; Xavier Bouclet 2025</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XVG0Q9ZG4E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XVG0Q9ZG4E');
</script>


  

</body>

</html>
